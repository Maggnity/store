<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>Menu</title>
        <link
            rel="stylesheet"
            href="./index.css"
        />
    </head>
    <body>
        <section class="login">
            <h3>Login</h3>

            <!-- Form que o Spring Security reconhece -->
            <form
                th:action="@{/login}"
                method="post"
            >
                <div>
                    <input
                        type="text"
                        name="username"
                        placeholder="Usu치rio"
                        required
                    />
                </div>
                <div>
                    <input
                        type="password"
                        name="password"
                        placeholder="Senha"
                        required
                    />
                </div>
                <div>
                    <button type="submit">Entrar</button>
                </div>
            </form>

            <!-- Exibe erro de login se ?error=true -->
            <div th:if="${param.error}">
                <p style="color: red">Usu치rio ou senha inv치lidos</p>
            </div>

            <!-- Exibe mensagem de logout se ?logout=true -->
            <div th:if="${param.logout}">
                <p style="color: green">Logout realizado com sucesso</p>
            </div>
        </section>

        <script>
            let token = null;

            document
                .getElementById('login-btn')
                .addEventListener('click', async () => {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;

                    const res = await fetch(
                        'http://localhost:8080/api/auth/login',
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password }),
                        }
                    );

                    if (!res.ok) {
                        alert('Login inv치lido!');
                        return;
                    }

                    const data = await res.json();
                    token = data.token;
                    localStorage.setItem('token', token);

                    // alert('Login realizado com sucesso!');
                });

            // Exemplo de fetch autenticado
            async function fetchComToken(url, options = {}) {
                const t = localStorage.getItem('token');
                return fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        Authorization: `Bearer ${t}`,
                    },
                });
            }
        </script>
    </body>
</html>
