<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>Login</title>
        <link
            rel="stylesheet"
            href="./index.css"
        />
    </head>
    <body>
        <section class="login">
            <h3>Login</h3>

            <!-- Form sem submit automático -->
            <div>
                <input
                    type="text"
                    id="username"
                    placeholder="Usuário"
                    required
                />
            </div>
            <div>
                <input
                    type="password"
                    id="password"
                    placeholder="Senha"
                    required
                />
            </div>
            <div>
                <button
                    type="button"
                    id="login-btn"
                >
                    Entrar
                </button>
            </div>

            <div
                id="msg"
                style="margin-top: 10px"
            ></div>
        </section>

        <script>
            const btn = document.getElementById('login-btn');
            const msgDiv = document.getElementById('msg');

            btn.addEventListener('click', async () => {
                const username = document
                    .getElementById('username')
                    .value.trim();
                const password = document
                    .getElementById('password')
                    .value.trim();

                if (!username || !password) {
                    msgDiv.innerHTML =
                        '<p style="color:red;">Preencha usuário e senha</p>';
                    return;
                }

                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    if (!res.ok) {
                        msgDiv.innerHTML =
                            '<p style="color:red;">Usuário ou senha inválidos</p>';
                        return;
                    }

                    const data = await res.json();
                    localStorage.setItem('token', data.token);

                    msgDiv.innerHTML =
                        '<p style="color:green;">Login realizado com sucesso!</p>';

                    // Redireciona para home após login
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } catch (err) {
                    console.error(err);
                    msgDiv.innerHTML =
                        '<p style="color:red;">Erro no servidor, tente novamente</p>';
                }
            });

            // Função utilitária para fetch autenticado
            async function fetchComToken(url, options = {}) {
                const token = localStorage.getItem('token');
                return fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        Authorization: `Bearer ${token}`,
                    },
                });
            }
        </script>
    </body>
</html>
